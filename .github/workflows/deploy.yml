name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Pages
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Copy functions and build
        run: |
          bun run copy:functions
          bun run build:frontend
      
      - name: Configure wrangler.toml for Production
        run: |
          # Inject production D1 database_id (replace "local")
          if [ -n "${{ secrets.CF_D1_DATABASE_ID }}" ]; then
            sed -i 's/database_id = "local"/database_id = "${{ secrets.CF_D1_DATABASE_ID }}"/' wrangler.toml
          fi
          
          # Optional: Override database_name
          if [ -n "${{ secrets.CF_D1_DATABASE_NAME }}" ]; then
            sed -i 's/database_name = "void-vault-db"/database_name = "${{ secrets.CF_D1_DATABASE_NAME }}"/' wrangler.toml
          fi
          
          # Optional: Override R2 bucket_name
          if [ -n "${{ secrets.CF_R2_BUCKET_NAME }}" ]; then
            sed -i 's/bucket_name = "void-vault-storage"/bucket_name = "${{ secrets.CF_R2_BUCKET_NAME }}"/' wrangler.toml
          fi
          
          echo "âœ… wrangler.toml configured for production"
          cat wrangler.toml
      
      - name: Deploy to Cloudflare Pages (Production)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=void-vault --branch=main
      
      - name: Run D1 migrations (Production)
        if: github.ref == 'refs/heads/main'
        run: |
          npx wrangler d1 migrations apply void-vault-db --remote
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
